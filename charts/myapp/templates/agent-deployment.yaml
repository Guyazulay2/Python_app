apiVersion: apps/v1
kind: Deployment
metadata:
  name: agent
  labels:
    app: agent
spec:
  replicas: 1
  selector:
    matchLabels:
      app: agent
  template:
    metadata:
      labels:
        app: agent
    spec:
      # ğŸš¨ ×”×’×“×¨×” ×§×¨×™×˜×™×ª 1: ×”×¨×¦×ª ×”×§×•× ×˜×™×™× ×¨ ×‘-Host PID Namespace
      # ×××¤×©×¨ ×œ-Agent ×œ×¨××•×ª ××ª ×ª×”×œ×™×›×™ ×”×××¨×— (Host)
      hostPID: true
      
      containers:
      - name: agent
        # ×”×ª××•× ×” ×•×”×ª×’×™×ª × ××©×›×™× ××§×•×‘×¥ values.yaml (×›×’×•×Ÿ app_azure-agent)
        image: "{{ .Values.agent.image }}:{{ .Values.agent.tag }}"
        
        # âœ… ×”×ª×™×§×•×Ÿ ×”×§×¨×™×˜×™: ××•×©×š ×ª××•× ×” ××§×•××™×ª ×‘××§×•× ×œ× ×¡×•×ª ×œ××©×•×š ××”×¢× ×Ÿ
        imagePullPolicy: {{ .Values.agent.imagePullPolicy | default "IfNotPresent" }}

        env:
          # ××©×ª× ×™ ×¡×‘×™×‘×” ×§×¨×™×˜×™×™×
        - name: MASTER_URL
          # ğŸ’¡ ×–×” ×¦×¨×™×š ×œ×”×¦×‘×™×¢ ×¢×œ ×”-Service ×”×¤× ×™××™ ×©×œ ×”-Backend
          value: "{{ .Values.agent.masterUrl }}" 
        - name: AGENT_HOSTNAME
          value: "k8s-agent-host"
        
        volumeMounts:
        # ğŸš¨ ×”×’×“×¨×” ×§×¨×™×˜×™×ª 2: ×”×¨×›×‘×ª ×©×§×¢ ×”×“×•×§×¨
        # ×××¤×©×¨ ×œ-Agent ×œ××¡×•×£ × ×ª×•× ×™ ×§×•× ×˜×™×™× ×¨×™×
        - name: docker-sock
          mountPath: /var/run/docker.sock
          readOnly: true
          
        # ğŸš¨ ×”×’×“×¨×” ×§×¨×™×˜×™×ª 3: ×’×™×©×” ×œ××¢×¨×›×ª ×”×§×‘×¦×™× ×©×œ ×”×××¨×—
        # × ×“×¨×© ×›×“×™ ×œ××¡×•×£ × ×ª×•× ×™× ×¢×œ ×”××¢×¨×›×ª ×›×•×œ×” (×¢×‘×•×¨ psutil)
        - name: host-root
          mountPath: /host
          readOnly: true
        
        # ğŸ’¡ ×”×’×“×¨×•×ª ×”×¨×©××•×ª ××™×•×—×“×•×ª ×”×“×¨×•×©×•×ª ×œ×¡×•×›×Ÿ × ×™×˜×•×¨/××™×¡×•×£ × ×ª×•× ×™×
        securityContext:
          capabilities:
            add:
              - NET_ADMIN
              - SYS_ADMIN

      # ×”×’×“×¨×ª Volumes ×”××©×ª××©×™× ×‘-HostPath (×”×§×¨×™×˜×™×•×ª ×œ-Agent)
      volumes:
        - name: docker-sock
          hostPath:
            path: /var/run/docker.sock
        - name: host-root
          hostPath:
            path: /
