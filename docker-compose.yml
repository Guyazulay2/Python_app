version: '3.8'

services:
  # ===================================
  # 1. 砖专转 PostgreSQL
  # ===================================
  postgres:
    image: postgres:15-alpine
    container_name: my_postgres
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: mydb
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ===================================
  # 2. 砖专转 Backend (Master / FastAPI)
  # ===================================
  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    container_name: my_backend
    ports:
      - "8000:8000" 
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: mydb
      DB_HOST: postgres
    depends_on:
      postgres:
        condition: service_healthy

  # ===================================
  # 3. 砖专转 Frontend (React/Nginx)
  # ===================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: my_frontend
    ports:
      - "3000:80" 
    depends_on:
      - backend

  # ===================================
  # 4. 砖专转 Prometheus
  # ===================================
  prometheus:
    image: prom/prometheus
    container_name: my_prometheus
    volumes:
      - /home/ubuntu/Desktop/app_azure/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  # ===================================
  # 5. 砖专转 Grafana
  # ===================================
  grafana:
    image: grafana/grafana:latest
    container_name: my_grafana
    ports:
      - "4000:3000"
    depends_on:
      - prometheus 

  # ===================================
  # 6. 砖专转 Agent (住 砖砖 转 -Master)
  # ===================================
  agent:
    build:
      context: ./agent
      dockerfile: Dockerfile
    container_name: my_agent
    environment:
      MASTER_URL: http://backend:8000/api/agent/data 
      AGENT_HOSTNAME: docker-compose-agent
    depends_on:
      - backend
    #  专砖转 拽专转 住祝 转 转:
    volumes:
      # 砖 砖拽注 拽专 (住祝 转 拽专)
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # 砖 注专转 拽爪 砖 专 (注专 psutil 住祝 转 驻专)
      - /:/host:ro
    # 专爪转 拽专 爪 Host PID Namespace (注专 psutil)
    pid: "host" 
    # 专爪转 拽专 爪 注祝
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN

# 住 拽注 转 住
volumes:
  postgres_data:
